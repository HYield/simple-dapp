<template lang="pug">
#vault(v-if="isDrizzleInitialized")
  v-app
    v-app-bar(app) {{ config.TITLE }}
    v-main
      v-container(fluid)
        div.columns
                div.column.is-half
                        info-message(:status="config.VAULT_STATUS")
        v-card
          v-card-title Vault
          v-card-text
            div Version: {{ vault_version }}
            div Performance Fee: {{ vault_perfFee }}%
            div {{ config.WANT_SYMBOL }} price (CoinGecko ü¶é): {{ want_price | toCurrency(4) }}
            div Deposit Limit: {{ vault_deposit_limit | fromWei(2, vault_decimals) }}        {{ config.WANT_SYMBOL }}
            div Total Assets: {{ vault_total_assets | fromWei(2, vault_decimals) }}        {{ config.WANT_SYMBOL }}
            div Total AUM: {{ vault_total_aum | toCurrency(2, vault_decimals) }}
            div.spacer
            //- div Growth :  {{ roi.toFixed(3) }}%
            div Estimated Daily APY :  {{ (get_yearly_apy / 365).toFixed(3) }}%
            //- div Weekly APY : {{ get_weekly_apy / 51}}%
            div Estimated Yearly APY : {{ get_yearly_apy }}%
            div.spacer
            div Price Per Share: {{ vault_price_per_share | fromWei(8, vault_decimals) }}
            div Available limit: {{ vault_available_limit | fromWei(2, vault_decimals) }} {{ config.WANT_SYMBOL }}
            v-progress-linear(:value="progress_limit" height="20px") {{ Math.round(progress_limit) }}%
            v-card-actions
              v-btn <a :href="chainExplorer + '/address/' + config.VAULT_ADDR + '#code'" target="_blank"> üìÉContract </a>
        div.spacer
        v-card
          v-card-title Strategies
          v-card-text
            div(v-for="(strategy, index) in strategies")
                div Strat. {{ index }}: {{ strategy.name }}
                    v-card-actions
                        v-btn <a :href="chainExplorer + '/address/' + strategy.address + '#code'" target="_blank"> üìÉContract </a>
        div.spacer
        v-card
          v-card-title Wallet
          v-card-text
            div Deposited value: {{ vault_net_deposited }} {{ config.WANT_SYMBOL }}
            div Vault shares: {{ yvtoken_balance | fromWei(2, vault_decimals) }}
            div {{ config.WANT_SYMBOL }} Balance: {{ want_balance | fromWei(2, vault_decimals) }}
            div Your {{ chainCoin }} Balance: {{ coin_balance | fromWei(2) }}
        div.spacer

        div(v-if="is_guest || yfi_needed <= 0")
                //- span You are a guest. Welcome to the Citadel üè∞
                v-card
                  v-card-title Manage
                  v-card-text
                    v-text-field(v-if="vault_available_limit > 0",v-model.number="amount", size="is-small", type="number",min=0,:label="(actionSwitch ? `Deposit amount` : `Withdraw amount`)")
                    span(v-if="vault_available_limit <= 0") Deposits closed.
                    v-card-actions
                      v-switch(v-model="actionSwitch",:label="`${actionSwitch ? `Deposit` : `Withdraw`}`")
                      v-btn(
                              v-if="vault_available_limit > 0 && !has_allowance_vault",
                              :disabled="has_allowance_vault",
                              @click.prevent="on_approve_vault"
                      ) {{ has_allowance_vault ? '‚úÖ Approved' : 'üöÄ Approve Vault' }}
                      v-btn(
                              v-if="actionSwitch ? vault_available_limit > 0: has_allowance_vault ",
                              :disabled="!has_allowance_vault",
                              @click.prevent="on_vault_action_click"
                      ) {{(actionSwitch ? ` üè¶ Deposit` : ` üí∏ Withdraw`)}}
                      v-btn(
                              v-if="actionSwitch ? vault_available_limit > 0 : has_allowance_vault",
                              :disabled="actionSwitch ? !has_allowance_vault : !has_yvtoken_balance",
                              @click.prevent="on_all_click"
                      ) {{(actionSwitch ? `üè¶ Deposit all` : `üí∏ Withdraw all`)}}
                      //- v-btn(:disabled="!has_yvtoken_balance", @click.prevent="on_withdraw_all") üí∏ Withdraw All
        div(v-else)
                .red
                        span ‚õî You need {{ yfi_needed | fromWei(4) }} YFI more to enter the Citadel ‚õî
                <div v-konami @konami="bribe_unlocked = !bribe_unlocked"></div>
                div(v-if="bribe_unlocked")
                        span If you still want to join the party...
                        |
                        v-btn(v-if="has_allowance_bribe", @click.prevent="on_bribe_the_bouncer") üí∞ Bribe the bouncer with ({{ bribe_cost | fromWei(3) }} YFI)
                        v-btn(v-if="!has_allowance_bribe", @click.prevent="on_approve_bribe") üöÄ Approve Bribe
                div(v-else)
                        span Remember Konami üéÆ
        v-alert(v-if="error" type="error")
                span {{ error }}
        div.spacer
                .muted
                        span Made with üíô
                        | 
                        span yVault:
                        | 
                        a(:href="'https://twitter.com/' + config.VAULT_DEV", target="_blank") {{ config.VAULT_DEV }}
                        | 
                        span - Guest List:
                        | 
                        a(href="https://twitter.com/bantg", target="_blank") bantg
                        | 
                        span - UI:
                        | 
                        a(href="https://twitter.com/fameal", target="_blank") fameal
                        |, 
                        a(href="https://twitter.com/emilianobonassi", target="_blank") emiliano
                        |, 
                        a(href="https://twitter.com/akshaynexust", target="_blank") akshaynexust
div(v-else)
        div Loading yApp...
</template>

<script>

import { mapGetters } from "vuex";
import { ethers } from "ethers";
import axios from "axios";
import ProgressBar from './components/ProgressBar';
import InfoMessage from './components/InfoMessage';
import GuestList from "./abi/GuestList.json";
import yVaultV2 from "./abi/yVaultV2.json";
import yStrategy from "./abi/yStrategy.json";
import ERC20 from "./abi/ERC20.json";

import Web3 from "web3";

let web3 = new Web3(Web3.givenProvider);

const max_uint =  ethers.BigNumber.from(2).pow(256).sub(1).toString();
const BN_ZERO =  ethers.BigNumber.from(0);
const ADDRESS_ZERO = "0x0000000000000000000000000000000000000000";

const ERROR_NEGATIVE = "You have to deposit a positive number of tokens üêÄ";
const ERROR_NOT_ENOUGH_DEPOSIT= "You don't have enough tokens to deposit";
const ERROR_NOT_ENOUGH_SHARES = "You don't have enough vault tokens to withdraw";
const ERROR_NEGATIVE_ALL = "You don't have tokens to deposit üêÄ";
const ERROR_NEGATIVE_WITHDRAW = "You don't have any vault shares";
const ERROR_GUEST_LIMIT = "That would exceed your guest limit. Try less.";
const ERROR_GUEST_LIMIT_ALL =
  "That would exceed your guest limit. Try not doing all in.";

export default {
  name: "Vault",
  components: {
    ProgressBar,
  },
  props: ['config', 'chainId', 'chainCoin', 'chainExplorer'],
  data() {
    return {
      username: null,
      actionSwitch:true,
      want_price: 0,
      amount: 0,
      amount_wrap: 0,
      strategies: [],
      strategies_balance: 0,
      average_price: 0,
      error: null,
      contractGuestList: null,
      is_guest: false,
      entrance_cost: ethers.BigNumber.from("1"),
      total_yfi: ethers.BigNumber.from("0"),
      bribe_unlocked: false,
      bribe_cost: ethers.BigNumber.from("0"),
      vault_activation: 0,
      roi_year: 0,
    };
  },
  filters: {
    fromWei(data, precision, decimals) {
      if (decimals === undefined) decimals = 18;
      if (data === "loading") return data;
      if (data > 2 ** 255) return "‚ôæÔ∏è";
      let value = ethers.utils.commify(ethers.utils.formatUnits(data, decimals));
      let parts = value.split(".");

      if (precision === 0) return parts[0];

      return parts[0] + "." + parts[1].slice(0, precision);
    },
    fromWeiToFloat(data, decimals) {
      if (decimals === undefined) decimals = 18;
      if (data === "loading") return data;
      if (data > 2 ** 255) return "‚ôæÔ∏è";
      let value = ethers.utils.formatUnits(data, decimals)
      return parseFloat(value)
    },
    fromWei15(data, precision) {
      if (data === "loading") return data;
      if (data > 2 ** 255) return "‚ôæÔ∏è";
      let value = ethers.utils.commify(ethers.utils.formatUnits(data, 15));
      let parts = value.split(".");

      if (precision === 0) return parts[0];

      return parts[0] + "." + parts[1].slice(0, precision);
    },
    toPct(data, precision) {
      if (isNaN(data)) return "-";
      return `${(data * 100).toFixed(precision)}%`;
    },
    toCurrency(data, precision) {
      if ( !data ) return "-";
      if (typeof data !== "number") {
        data = parseFloat(data);
      }
      var formatter = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        minimumFractionDigits: precision,
      });
      return formatter.format(data);
    },
  },
  methods: {
    on_approve_vault() {
      this.drizzleInstance.contracts["WANT"].methods["approve"].cacheSend(
        this.vault,
        max_uint,
        { from: this.activeAccount }
      );
    },
    on_approve_bribe() {
      this.drizzleInstance.contracts["YFI"].methods["approve"].cacheSend(
        this.vault,
        max_uint,
        { from: this.activeAccount }
      );
    },
    on_deposit() {
      this.error = null;

      if (this.amount <= 0) {
        this.error = ERROR_NEGATIVE;
        this.amount = 0;
        return;
      }

      else if(this.amount > this.want_balance){
        this.error = ERROR_NOT_ENOUGH_DEPOSIT;
        this.amount = 0;
        return;
      }

      this.drizzleInstance.contracts["Vault"].methods["deposit"].cacheSend(
        ethers.utils.parseUnits(this.amount.toString(), this.vault_decimals).toString(),
        {
          from: this.activeAccount,
        }
      );
    },
    on_vault_action_click() {
      if(this.actionSwitch) {
        this.on_deposit()
      }
      else {
        this.on_withdraw()
      }
    },
    on_all_click(){
      if(this.actionSwitch) {
        //Deposit all
        this.on_deposit_all()
      }
      else {
        this.on_withdraw_all();
      }
    },
    on_deposit_all() {
      if (this.want_balance <= 0) {
        this.error = ERROR_NEGATIVE_ALL;
        this.amount = 0;
        return;
      }

      this.drizzleInstance.contracts["Vault"].methods["deposit"].cacheSend({
        from: this.activeAccount,
      });
    },
    on_bribe_the_bouncer() {
      console.log(this.contractGuestList.methods);
      this.contractGuestList.methods
        .bribe_the_bouncer()
        .send({ from: this.activeAccount })
        .then((response) => {
          console.log(response);
        });
    },
    getVaultSharesForAmount(amount) {
      let curPricePerShare = this.$options.filters.fromWeiToFloat(this.vault_price_per_share)
      return amount / curPricePerShare
    },
    on_withdraw() {
      if (this.yvtoken_balance <= 0) {
        this.error = ERROR_NEGATIVE_WITHDRAW;
        this.amount = 0;
        return;
      }
      if (this.amount <= 0) {
        this.error = ERROR_NEGATIVE;
        this.amount = 0;
        return;
      }
      //
      let withdrawSharesAmount = this.getVaultSharesForAmount(this.amount)
      let currVaultShares = this.$options.filters.fromWeiToFloat(this.yvtoken_balance)

      if(withdrawSharesAmount > currVaultShares) {
        this.error = ERROR_NOT_ENOUGH_SHARES;
        this.amount = 0;
        return;
      }
      this.drizzleInstance.contracts["Vault"].methods["withdraw"].cacheSend(
        ethers.utils.parseUnits(withdrawSharesAmount.toString(), this.vault_decimals).toString(),{
        from: this.activeAccount,
      });
    },
    on_withdraw_all() {
      if (this.yvtoken_balance <= 0) {
        this.error = ERROR_NEGATIVE_WITHDRAW;
        this.amount = 0;
        return;
      }
      this.drizzleInstance.contracts["Vault"].methods["withdraw"].cacheSend({
        from: this.activeAccount,
      });
    },
    async load_reverse_ens() {
      let lookup = this.activeAccount.toLowerCase().substr(2) + ".addr.reverse";
      let resolver = await this.drizzleInstance.web3.eth.ens.resolver(lookup);
      let namehash = ethers.utils.namehash(lookup);
      this.username = await resolver.methods.name(namehash).call();
    },
    async get_strategies(vault) {
      for (let i = 0, p = Promise.resolve(); i < 20; i++) {
        p = p.then(
          (_) =>
            new Promise((resolve) =>
              vault.methods
                .withdrawalQueue(i)
                .call()
                .then((strat_addr) => {
                  if (strat_addr !== ADDRESS_ZERO) {
                    let Strategy = new web3.eth.Contract(yStrategy, strat_addr);
                    let data = {
                      address: strat_addr,
                      balance: null,
                    };

                    // Add to strat address to array
                    this.$set(this.strategies, i, data);

                    Strategy.methods
                      .name()
                      .call()
                      .then((name) => {
                        console.log(name);
                        this.$set(this.strategies[i], "name", name);
                      });
                  }

                  resolve();
                })
            )
        );
      }
    },
    call(contract, method, args, out = "number") {
      let key = this.drizzleInstance.contracts[contract].methods[
        method
      ].cacheCall(...args);
      let value;
      try {
        value = this.contractInstances[contract][method][key].value;
      } catch (error) {
        value = null;
      }
      switch (out) {
        case "number":
          if (value === null) value = 0;
          return ethers.BigNumber.from(value);
        case "address":
          return value;
        default:
          return value;
      }
    },
  },
  computed: {
    ...mapGetters("accounts", ["activeAccount", "activeBalance"]),
    ...mapGetters("drizzle", ["drizzleInstance", "isDrizzleInitialized"]),
    ...mapGetters("contracts", ["getContractData", "contractInstances"]),

    user() {
      return this.activeAccount;
    },
    vault() {
      return this.drizzleInstance.contracts["Vault"].address;
    },
    vault_perfFee() {
      return this.call("Vault", "performanceFee", [], "string") / 100;
    },
    vault_version() {
      return this.call("Vault", "apiVersion", [], "string");
    },
    vault_supply() {
      return this.call("Vault", "totalSupply", []);
    },
    vault_deposit_limit() {
      return this.call("Vault", "depositLimit", []);
    },
    vault_total_assets() {
      return this.call("Vault", "totalAssets", []);
    },
    vault_available_limit() {
      if (this.config.VAULT_STATUS == 'active' || this.config.VAULT_STATUS == '') {
        return this.call("Vault", "availableDepositLimit", []);
      } else {
        return BN_ZERO;
      }
    },
    vault_total_aum() {
      let toFloat = ethers.BigNumber.from(10).pow(16).toString();
      let numAum = this.vault_total_assets.div(toFloat).toNumber();
      return (numAum / 100) * this.want_price;
    },
    vault_price_per_share() {
      return this.call("Vault", "pricePerShare", []);
    },
    vault_net_deposited() {
      let currVaultShares = this.$options.filters.fromWeiToFloat(this.yvtoken_balance)
      let curPricePerShare = this.$options.filters.fromWeiToFloat(this.vault_price_per_share)
      return  (currVaultShares * curPricePerShare).toLocaleString()
    },
    vault_decimals() {
      return this.call("Vault", "decimals", []);
    },
    yvtoken_balance() {
      return this.call("Vault", "balanceOf", [this.activeAccount]);
    },
    want_balance() {
      return this.call("WANT", "balanceOf", [this.activeAccount]);
    },
    coin_balance() {
      return this.activeBalance;
    },
    progress_limit() {
      return (this.vault_deposit_limit.isZero() ? 0: (this.vault_deposit_limit - this.vault_available_limit) / this.vault_deposit_limit *100);
    },
    yfi_needed() {
      return this.entrance_cost.sub(this.total_yfi);
    },
    has_allowance_bribe() {
      return !this.call("YFI", "allowance", [
        this.activeAccount,
        this.vault,
      ]).isZero();
    },
    get_daily_apy(){
      return this.roi != undefined ? (this.roi / 7).toFixed(3) : 0;
    },
    get_weekly_apy(){
      return this.roi != undefined ? this.roi.toFixed(3) : 0;
    },
    get_yearly_apy(){
      return this.roi_year != undefined ? this.roi_year.toFixed(3) : 0;
    },
    has_allowance_vault() {
      return !this.call("WANT", "allowance", [
        this.activeAccount,
        this.vault,
      ]).isZero();
    },
    has_want_balance() {
      return this.want_balance > 0;
    },
    has_yvtoken_balance() {
      return this.yvtoken_balance > 0;
    },
  },
  async created() {
    if (this.chainId && this.config.CHAIN_ID !== this.chainId) {
      window.location.href = '/'
    }
    axios
      .get(
        "https://api.coingecko.com/api/v3/simple/price?ids=" +
          this.config.COINGECKO_SYMBOL.toLowerCase() +
          "&vs_currencies=usd"
      )
      .then((response) => {
        this.want_price = response.data[this.config.COINGECKO_SYMBOL.toLowerCase()].usd;
      });

    //Active account is defined?
    if (this.activeAccount !== undefined) this.load_reverse_ens();

    let Vault = new web3.eth.Contract(yVaultV2, this.vault);
    console.log(Vault);
    this.get_strategies(Vault);
        this.is_guest = true;

    // Get GuestList contract and use it :)
    // Vault.methods.guestList().call().then((response) => {
    //     console.log(response)
    //     if (response == ADDRESS_ZERO) {
    //       //if there's not guest list, everyone is a guest ;)
    //       console.log("No guest list. Everyone is invited!");
    //       this.total_yfi = this.entrance_cost;
    //     } else {
    //       this.contractGuestList = new web3.eth.Contract(GuestList, response);

    //       this.contractGuestList.methods
    //         .guests(this.activeAccount)
    //         .call()
    //         .then((response) => {
    //           this.is_guest = response;
    //         });

    //       this.contractGuestList.methods.total_yfi(this.activeAccount).call().then((response) => {
    //         console.log("Total YFI: " + response.toString());
    //         this.total_yfi = ethers.BigNumber.from(response.toString());
    //       });

    //     Vault.methods.activation().call().then((vault_activation) => {
    //         this.contractGuestList.methods
    //           .entrance_cost(vault_activation)
    //           .call()
    //           .then((response) => {
    //             console.log("Entrance cost: " + response.toString());
    //             this.entrance_cost = ethers.BigNumber.from(
    //               response.toString()
    //             );
    //           });
    //       });
    //     this.contractGuestList.methods
    //       .bribe_cost()
    //       .call()
    //       .then((response) => {
    //         console.log("Bribe cost: " + response.toString());
    //         this.bribe_cost = ethers.BigNumber.from(response.toString());
    //       });
    //     }
    //   });

    // Get blocknumber and calc APY
    Vault.methods.pricePerShare().call().then( currentPrice => {
      const seconds_in_a_year = 3.154e+7;
      const now = Math.round(Date.now() / 1000);
      Vault.methods.activation().call().then(activationTime => {
      // 1 week ago
      const one_week_ago = (now - 60 * 60 * 24 * 7);
      const ts_past = one_week_ago < activationTime?activationTime:one_week_ago;

      const ts_diff = now - ts_past;

      console.log("TS Past: " + one_week_ago);
      console.log("TS Activation: " + activationTime);
          //TODO reference central api instead for apy
          let pastPrice = this.config.WANT_SYMBOL == "KUS" ? 10 * 1e18: 1e18;
          if(currentPrice > pastPrice) {
            console.log(`Pas price = ${pastPrice}`)
            let roi = (currentPrice / pastPrice - 1) * 100;
            console.log("Current Price: " + currentPrice);
            console.log("Past Price: " + pastPrice);
            this.roi = roi
            this.roi_year = roi/ts_diff*seconds_in_a_year;
            console.log("ROI week: " + roi);
            console.log("ROI year: " + this.roi_year);
          }
          else {
            this.roi = 0;
            this.roi_year = 0;
          }
      })

    });
    // Iterate through strats
  },
};
</script>
<style>
button {
  margin-right: 1em;
}
.muted {
  color: gray;
  font-size: 0.8em;
}
.muted a {
  text-decoration: underline;
}
.red {
  color: red;
  font-weight: 700;
}
.blue {
  color: blue;
  font-weight: 700;
}
.spacer {
  padding-top: 1em;
  padding-bottom: 1em;
}
a,
a:visited,
a:hover {
  color: gray;
}
</style>